<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Spencer Soundboard</title>
<style>
  :root { --bg:#0b0c10; --panel:#121318; --accent:#7dd3fc; --muted:#9aa0a6; --text:#e8eaed; --chip:#1f2330; }
  * { box-sizing:border-box; }
  body { margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; color:var(--text); background:linear-gradient(180deg, #0b0c10, #121318); }
  header { position:sticky; top:0; z-index:5; backdrop-filter:saturate(180%) blur(6px); background:rgba(11,12,16,.85); border-bottom:1px solid #1f2330; }
  .bar { max-width:1100px; margin:0 auto; padding:10px 16px; display:grid; gap:10px; grid-template-columns: 1fr 140px 120px 90px; align-items:center; }
  .bar > * { min-width:0; }
  .search { display:flex; align-items:center; gap:8px; background:var(--panel); border:1px solid #222634; padding:8px 10px; border-radius:12px; }
  .search input { flex:1; background:transparent; border:0; outline:0; color:var(--text); font-size:14px; }
  select, button, .btn { background:var(--panel); color:var(--text); border:1px solid #222634; border-radius:12px; padding:8px 10px; font-size:14px; }
  button:hover, .btn:hover, select:hover { border-color:#2d3347; }
  .grid { max-width:1100px; margin:18px auto; padding:0 16px 32px; display:grid; gap:12px; grid-template-columns: repeat(auto-fill, minmax(180px,1fr)); }
  .card { background:var(--panel); border:1px solid #1e2230; border-radius:16px; padding:12px; display:flex; flex-direction:column; gap:10px; transition:transform .05s ease; }
  .card.playing { border-color:var(--accent); box-shadow:0 0 0 1px rgba(125,211,252,.25) inset; transform:translateY(-1px); }
  .title { font-weight:600; line-height:1.2; font-size:14px; color:#eaf2ff; min-height:2.4em; }
  .meta { color:var(--muted); font-size:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .chips { display:flex; gap:6px; flex-wrap:wrap; }
  .chip { background:var(--chip); color:#cfd3dc; font-size:11px; padding:4px 6px; border-radius:999px; border:1px solid #2a3042; }
  .row { display:flex; gap:8px; align-items:center; }
  .row .grow { flex:1; }
  .k { font-size:11px; color:#9fb3c8; border:1px solid #2a3042; padding:2px 6px; border-radius:6px; }
  .foot { max-width:1100px; margin:0 auto 24px; padding:0 16px; color:#8b92a0; font-size:12px; }
  .vol { width:100%; }
  @media (max-width:780px) { .bar { grid-template-columns: 1fr 1fr; } .bar .hide-sm { display:none; } }
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="search">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="#9aa0a6"><path d="M21 21l-4.3-4.3m1.3-4.2A7.8 7.8 0 1 1 9.2 4.7a7.8 7.8 0 0 1 8.8 7.8z" stroke="#9aa0a6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>
      <input id="q" placeholder="Search clips… (label, tag)" autocomplete="off">
    </div>
    <select id="cat">
      <option value="All">All categories</option>
    </select>
    <button id="shuffle" title="Random clip (R)">Shuffle</button>
    <button id="stop" class="hide-sm" title="Stop all (Space)">Stop</button>
  </div>
</header>

<div class="grid" id="grid"></div>

<div class="foot">
  <div class="row" style="gap:14px">
    <div class="grow">Hotkeys: <span class="k">R</span> random, <span class="k">Space</span> stop all, <span class="k">1–9</span> trigger first 9 visible clips.</div>
    <div style="width:240px; display:flex; gap:8px; align-items:center;">
      <span style="font-size:12px;color:#9aa0a6;">Volume</span>
      <input id="vol" class="vol" type="range" min="0" max="1" step="0.01" value="1">
    </div>
  </div>
</div>

<script>
/** CONFIG **/
const MANIFEST_URL = 'sounds.json';        // same folder as this HTML
const ALLOW_OVERLAP = true;                // allow multiple clips at once
const PRELOAD = 'metadata';                // 'none' | 'metadata' | 'auto'
const DEFAULT_CATEGORY = 'All';

/**
 * Expected sounds.json format:
 * [
 *   {"file":"spencer_hi.wav","label":"Hi!","category":"Talking","tags":["greeting"]},
 *   {"file":"spencer_sing1.wav","label":"La-la","category":"Singing","tags":["vocalise"]},
 *   ...
 * ]
 */

const state = {
  clips: [],
  filtered: [],
  playing: new Map(),
  vol: 1,
  q: '',
  cat: DEFAULT_CATEGORY
};

const el = sel => document.querySelector(sel);
const grid = el('#grid');
const q = el('#q');
const cat = el('#cat');
const stopBtn = el('#stop');
const vol = el('#vol');
const shuffleBtn = el('#shuffle');

async function loadManifest() {
  const res = await fetch(MANIFEST_URL, { cache: 'no-store' });
  if (!res.ok) throw new Error('Failed to load sounds.json');
  const data = await res.json();
  // normalize
  state.clips = data.map((d, i) => ({
    id: i,
    file: d.file,
    label: d.label || (d.file || '').replace(/\.[^/.]+$/, '').replace(/[_-]+/g,' ').trim(),
    category: d.category || 'Uncategorized',
    tags: Array.isArray(d.tags) ? d.tags : [],
  }));
  buildCategoryList();
  applyFilter();
}

function buildCategoryList() {
  const cats = new Set([DEFAULT_CATEGORY]);
  state.clips.forEach(c => cats.add(c.category));
  cat.innerHTML = '';
  [...cats].forEach(cname => {
    const opt = document.createElement('option');
    opt.value = cname; opt.textContent = cname;
    cat.appendChild(opt);
  });
  cat.value = state.cat;
}

function applyFilter() {
  const term = (state.q || '').toLowerCase();
  const chosen = state.cat || DEFAULT_CATEGORY;
  state.filtered = state.clips.filter(c => {
    const inCat = chosen === DEFAULT_CATEGORY || c.category === chosen;
    if (!inCat) return false;
    if (!term) return true;
    return (c.label.toLowerCase().includes(term) ||
            c.tags.join(' ').toLowerCase().includes(term) ||
            c.file.toLowerCase().includes(term));
  });
  renderGrid();
}

function renderGrid() {
  grid.innerHTML = '';
  state.filtered.forEach((c, idx) => {
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.id = c.id;

    const title = document.createElement('div');
    title.className = 'title';
    title.textContent = c.label;

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.innerHTML = `<span>${c.category}</span><span class="k">${idx < 9 ? idx+1 : ''}</span>`;

    const chips = document.createElement('div');
    chips.className = 'chips';
    (c.tags || []).slice(0,3).forEach(t => {
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.textContent = t;
      chips.appendChild(chip);
    });

    const row = document.createElement('div');
    row.className = 'row';
    const play = document.createElement('button');
    play.textContent = 'Play';
    play.addEventListener('click', () => playClip(c, card));
    const stop = document.createElement('button');
    stop.textContent = 'Stop';
    stop.addEventListener('click', () => stopClip(c, card));
    row.append(play, stop);

    card.append(title, meta, chips, row);
    grid.appendChild(card);
  });
}

function playClip(c, cardEl) {
  if (!ALLOW_OVERLAP) stopAll();
  // stop existing same-clip first
  stopClip(c, cardEl);

  const a = new Audio(c.file);
  a.preload = PRELOAD;
  a.volume = state.vol;
  a.addEventListener('ended', () => {
    state.playing.delete(c.id);
    cardEl?.classList.remove('playing');
  });
  a.addEventListener('play', () => cardEl?.classList.add('playing'));
  a.addEventListener('pause', () => cardEl?.classList.remove('playing'));
  state.playing.set(c.id, a);
  a.play().catch(()=>{ /* autoplay restrictions on first click */ });
}

function stopClip(c, cardEl) {
  const a = state.playing.get(c.id);
  if (a) { a.pause(); a.currentTime = 0; state.playing.delete(c.id); }
  cardEl?.classList.remove('playing');
}

function stopAll() {
  for (const [id, a] of state.playing.entries()) {
    a.pause(); a.currentTime = 0;
  }
  state.playing.clear();
  document.querySelectorAll('.card.playing').forEach(el=>el.classList.remove('playing'));
}

function shuffleOne() {
  if (!state.filtered.length) return;
  const idx = Math.floor(Math.random() * state.filtered.length);
  const c = state.filtered[idx];
  const cardEl = document.querySelector(`.card[data-id="${c.id}"]`);
  playClip(c, cardEl);
}

q.addEventListener('input', (e)=>{ state.q = e.target.value; applyFilter(); });
cat.addEventListener('change', (e)=>{ state.cat = e.target.value; applyFilter(); });
vol.addEventListener('input', (e)=> {
  state.vol = parseFloat(e.target.value || '1') || 1;
  // live-update volumes of currently playing
  for (const a of state.playing.values()) a.volume = state.vol;
});
stopBtn.addEventListener('click', stopAll);
shuffleBtn.addEventListener('click', shuffleOne);

document.addEventListener('keydown', (e)=>{
  if (e.target.matches('input, textarea')) return;
  if (e.code === 'Space') { e.preventDefault(); stopAll(); }
  if (e.key.toLowerCase() === 'r') { e.preventDefault(); shuffleOne(); }
  const n = parseInt(e.key, 10);
  if (n >= 1 && n <= 9) {
    const c = state.filtered[n-1];
    if (c) {
      const cardEl = document.querySelector(`.card[data-id="${c.id}"]`);
      playClip(c, cardEl);
    }
  }
});

loadManifest().catch(err => {
  grid.innerHTML = '<div style="opacity:.8">Could not load sounds.json. Make sure it is present and allowed by your host.</div>';
  console.error(err);
});
</script>
</body>
</html>
