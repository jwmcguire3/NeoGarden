<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Spencer Soundboard</title>
<style>
  :root { --bg:#0b0c10; --panel:#121318; --accent:#7dd3fc; --muted:#9aa0a6; --text:#e8eaed; --chip:#1f2330; --border:#1e2230; }
  body.light { --bg:#fafafa; --panel:#ffffff; --accent:#2563eb; --muted:#555; --text:#111; --chip:#e5e7eb; --border:#d8dae0; }
  * { box-sizing:border-box }
  body { margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; color:var(--text); background:var(--bg); transition: background .2s, color .2s; }
  header { position:sticky; top:0; z-index:5; background:var(--panel); border-bottom:1px solid var(--border); padding:10px; display:flex; gap:10px; align-items:center; }
  input,button { font-size:14px; }
  .search input { padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:transparent; color:var(--text); }
  button { background:var(--panel); color:var(--text); border:1px solid var(--border); border-radius:10px; padding:8px 10px; cursor:pointer; }
  button:hover { border-color:var(--accent); }
  .toolbar { margin-left:auto; display:flex; gap:8px; }
  .grid { display:grid; gap:12px; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); padding:16px; }
  .card { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:10px; }
  .card.playing { border-color:var(--accent); }
  .row { display:flex; gap:6px; flex-wrap:wrap; }
  .title { font-weight:600; line-height:1.2 }
  /* Toast */
  .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#111a; color:#fff; padding:10px 14px; border-radius:10px; font-size:14px; opacity:0; pointer-events:none; transition:opacity .2s, transform .2s; backdrop-filter: blur(6px); }
  .toast.show { opacity:1; transform:translateX(-50%) translateY(-4px); }
  /* Fav toggle visual */
  #favToggle.active { border-color:var(--accent); box-shadow:0 0 0 1px color-mix(in srgb, var(--accent) 30%, transparent) inset; }
</style>
</head>
<body>
<header>
  <div class="search"><input id="q" placeholder="Search clips‚Ä¶"></div>
  <!-- Favorites toggle that changes when toggled -->
  <button id="favToggle" aria-pressed="false" title="Toggle favorites view">‚òÜ Show Favorites Only</button>
  <div class="toolbar">
    <button id="shuffle" title="Random (R)">Random</button>
    <button id="stop" title="Stop (Space)">Stop</button>
    <button id="theme" title="Dark/Light">üåô/‚òÄÔ∏è</button>
  </div>
</header>

<div class="grid" id="grid"></div>

<!-- Toast -->
<div id="toast" class="toast" role="status" aria-live="polite">Copied to clipboard</div>

<script>
const MANIFEST_URL = 'sounds.json';
const ALLOW_OVERLAP = true;
const PRELOAD = 'metadata';

const state = {
  clips: [], filtered: [], playing:new Map(),
  vol:1, q:'', favOnly:false, favorites:new Set(),
  loop:new Set(), theme:localStorage.getItem('theme')||'dark'
};

document.body.classList.toggle('light', state.theme==='light');

const el = s => document.querySelector(s);
const grid = el('#grid');
const favBtn = el('#favToggle');
const toastEl = el('#toast');

function showToast(msg='Copied to clipboard') {
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> toastEl.classList.remove('show'), 1200);
}

async function loadManifest(){
  const res=await fetch(MANIFEST_URL,{cache:'no-store'});
  if(!res.ok) throw new Error('sounds.json not found');
  const data=await res.json();
  state.clips=data.map((d,i)=>({
    id:i, file:d.file,
    label:d.label||(d.file||'').replace(/\.[^/.]+$/,'').replace(/[_-]+/g,' ').trim(),
    tags:d.tags||[]
  }));
  try { state.favorites=new Set(JSON.parse(localStorage.getItem('favorites')||'[]')); }catch{}
  applyFilter();
  updateFavToggleUI();
}
function applyFilter(){
  const term=(state.q||'').toLowerCase();
  state.filtered=state.clips.filter(c=>{
    if(state.favOnly && !state.favorites.has(c.file)) return false;
    if(!term) return true;
    return c.label.toLowerCase().includes(term) || c.file.toLowerCase().includes(term);
  });
  renderGrid();
}
function renderGrid(){
  grid.innerHTML='';
  state.filtered.forEach((c)=>{
    const card=document.createElement('div');
    card.className='card'; card.dataset.id=c.id;

    const title=document.createElement('div');
    title.className='title'; title.textContent=c.label;

    const row=document.createElement('div'); row.className='row';
    const play=btn('‚ñ∂','Play',()=>playClip(c,card));
    const stop=btn('‚ñ†','Stop',()=>stopClip(c,card));
    const loop=btn('üîÅ','Loop',()=>{
      if(state.loop.has(c.file)){ state.loop.delete(c.file); loop.style.opacity=0.5; }
      else { state.loop.add(c.file); loop.style.opacity=1; }
    });
    loop.style.opacity = state.loop.has(c.file) ? 1 : 0.5;

    const fav=btn( state.favorites.has(c.file) ? '‚òÖ' : '‚òÜ', 'Favorite',()=>{
      if(state.favorites.has(c.file)) state.favorites.delete(c.file);
      else state.favorites.add(c.file);
      localStorage.setItem('favorites', JSON.stringify([...state.favorites]));
      fav.textContent = state.favorites.has(c.file) ? '‚òÖ' : '‚òÜ';
      if(state.favOnly) applyFilter(); // refresh view when fav-only
      updateFavToggleUI();
    });

    const share=btn('üîó','Copy link',()=>{
      const url=new URL(window.location.href);
      url.searchParams.set('clip', c.file);
      navigator.clipboard.writeText(url.toString()).then(()=>{
        showToast('Copied to clipboard');
      }).catch(()=> showToast('Copy failed'));
    });

    row.append(play,stop,loop,fav,share);
    card.append(title,row);
    grid.appendChild(card);
  });
}
function btn(text,title,onclick){
  const b=document.createElement('button'); b.textContent=text; b.title=title; b.onclick=onclick; return b;
}

function playClip(c,card){
  if(!ALLOW_OVERLAP) stopAll();
  stopClip(c,card);
  const a=new Audio(c.file);
  a.preload=PRELOAD; a.volume=state.vol; a.loop=state.loop.has(c.file);
  a.onended=()=>{ state.playing.delete(c.id); card.classList.remove('playing'); };
  a.onplay =()=> card.classList.add('playing');
  a.onpause=()=> card.classList.remove('playing');
  state.playing.set(c.id,a); a.play().catch(()=>{});
}
function stopClip(c,card){
  const a=state.playing.get(c.id);
  if(a){ a.pause(); a.currentTime=0; state.playing.delete(c.id); }
  card?.classList.remove('playing');
}
function stopAll(){
  for(const [id,a] of state.playing.entries()){ a.pause(); a.currentTime=0; }
  state.playing.clear();
  document.querySelectorAll('.card.playing').forEach(e=>e.classList.remove('playing'));
}
function shuffleOne(){
  if(!state.filtered.length) return;
  const c = state.filtered[Math.floor(Math.random()*state.filtered.length)];
  const card=document.querySelector(`.card[data-id="${c.id}"]`);
  playClip(c,card);
}

function updateFavToggleUI(){
  const on = state.favOnly;
  favBtn.classList.toggle('active', on);
  favBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
  favBtn.textContent = on ? '‚òÖ Showing Favorites' : '‚òÜ Show Favorites Only';
}

document.addEventListener('keydown',e=>{
  if(e.target.matches('input,textarea')) return;
  if(e.code==='Space'){ e.preventDefault(); stopAll(); }
  if(e.key.toLowerCase()==='r'){ e.preventDefault(); shuffleOne(); }
  const n=parseInt(e.key,10);
  if(n>=1&&n<=9){
    const c=state.filtered[n-1];
    if(c){ const card=document.querySelector(`.card[data-id="${c.id}"]`); playClip(c,card); }
  }
});

el('#q').oninput = e => { state.q = e.target.value; applyFilter(); };
el('#stop').onclick = stopAll;
el('#shuffle').onclick = shuffleOne;
favBtn.onclick = () => { state.favOnly = !state.favOnly; updateFavToggleUI(); applyFilter(); };
el('#theme').onclick = () => {
  state.theme = state.theme==='dark' ? 'light' : 'dark';
  localStorage.setItem('theme', state.theme);
  document.body.classList.toggle('light', state.theme==='light');
};

// Auto-play via ?clip= param
const params = new URLSearchParams(location.search);
function tryAutoplayParam(){
  const clip=params.get('clip'); if(!clip) return;
  const c=state.clips.find(x=>x.file===clip); if(!c) return;
  const card=grid.querySelector(`.card[data-id="${c.id}"]`);
  if(card) playClip(c,card);
}
loadManifest().then(()=> setTimeout(tryAutoplayParam, 300)).catch(err=>{
  grid.innerHTML = '<div style="opacity:.8;padding:16px">Could not load sounds.json.</div>';
  console.error(err);
});
</script>
</body>
</html>
