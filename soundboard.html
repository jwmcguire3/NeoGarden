<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>I Love You Jessica</title>
<link href="https://fonts.googleapis.com/css2?family=Berkshire+Swash&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f7e36a;      /* Spencer yellow */
    --panel:#fffbe6;   /* soft card */
    --text:#271d00;    /* warm dark */
    --border:#e7d66b;
    --accent:#6b2aa5;  /* Spencer purple */
    --accent-2:#8b3ad6;
  }
  *{box-sizing:border-box}
  body{ margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--text); background:var(--bg); }

  /* Header */
  .top{ max-width:1100px; margin:24px auto 8px; padding:0 16px; text-align:center; }
  .title{ font-family:"Berkshire Swash", serif; font-size:clamp(28px,6vw,58px); line-height:1.05; margin:8px 0 14px; }
  .hero-img{ display:block; margin:0 auto 12px; width:min(520px,80vw); height:auto; border-radius:18px; border:3px solid rgba(0,0,0,.06); box-shadow:0 10px 30px rgba(0,0,0,.15); background:#fff; }

  /* Sections */
  .wrap{ max-width:1100px; margin:8px auto 34px; padding:0 16px; }
  .divider{ font-weight:800; letter-spacing:.3px; color:#3a2b60; margin:18px 0 8px; display:flex; align-items:center; gap:10px; }
  .divider::after{ content:""; height:2px; flex:1; background:linear-gradient(90deg, var(--accent), transparent 60%); border-radius:2px; }

  /* Grid & Cards */
  .grid{ display:grid; gap:12px; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); }
  .card{
    background:var(--panel);
    border:2px solid var(--border);
    border-radius:14px;
    padding:12px;
    display:flex; flex-direction:column; gap:10px;
    box-shadow:0 2px 0 rgba(0,0,0,.03);
    cursor:pointer;
    transition:transform .06s ease;
  }
  .card:active{ transform:translateY(1px); }
  .card.playing{ box-shadow:0 0 0 2px var(--accent) inset; }
  .toprow{ display:flex; align-items:center; gap:10px; }
  .label{ font-weight:700; line-height:1.2; }
  .star{
    margin-left:auto;
    appearance:none;
    border:2px solid var(--accent);
    background:#fffdf4;
    color:var(--accent);
    font-weight:800;
    border-radius:10px;
    padding:6px 10px;
    cursor:pointer;
  }
  .star.fav{ background:var(--accent); color:#fff; }
  /* Drag ghost */
  .sortable-ghost{ opacity:.5; }
</style>
</head>
<body>

<section class="top">
  <h1 class="title">I Love You Jessica</h1>
  <img class="hero-img" src="spencer.png" alt="Spencer character">
</section>

<div class="wrap">
  <div class="divider">Favorites</div>
  <div id="favGrid" class="grid"></div>

  <div class="divider" style="margin-top:24px;">All Clips</div>
  <div id="allGrid" class="grid"></div>
</div>

<!-- SortableJS (touch-friendly drag & drop) -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script>
const MANIFEST_URL = 'sounds.json';
const ALLOW_OVERLAP = false;

const state = {
  clips: [],             // {id,file,label}
  favSet: new Set(),     // Set<string file>
  favOrder: [],          // Array<string file> (manual order)
  playing: null          // {audio, id}
};

const favGrid = document.getElementById('favGrid');
const allGrid = document.getElementById('allGrid');

function savePrefs(){
  localStorage.setItem('favSet', JSON.stringify([...state.favSet]));
  localStorage.setItem('favOrder', JSON.stringify(state.favOrder));
}
function loadPrefs(){
  try{ state.favSet = new Set(JSON.parse(localStorage.getItem('favSet')||'[]')); }catch{}
  try{ state.favOrder = JSON.parse(localStorage.getItem('favOrder')||'[]') || []; }catch{}
}

async function init(){
  loadPrefs();
  const res = await fetch(MANIFEST_URL,{cache:'no-store'});
  const data = await res.json();
  state.clips = data.map((d,i)=>({
    id:i,
    file:d.file,
    label: d.label || (d.file||'').replace(/\.[^/.]+$/,'').replace(/[_-]+/g,' ').trim()
  }));

  // Ensure favOrder only contains existing files, and includes any newly-faved items at end
  state.favOrder = state.favOrder.filter(f => state.clips.find(c => c.file === f));
  for(const f of state.favSet){ if(!state.favOrder.includes(f)) state.favOrder.push(f); }

  render();

  // Enable drag & drop inside favorites only
  Sortable.create(favGrid, {
    animation: 120,
    ghostClass: 'sortable-ghost',
    handle: '.card',      // whole card draggable
    onSort: () => {
      // Read current DOM order into favOrder
      const newOrder = [...favGrid.querySelectorAll('.card')].map(el => el.dataset.file);
      state.favOrder = newOrder;
      savePrefs();
    }
  });
}

function render(){
  // Partition clips
  const favFiles = new Set(state.favOrder);
  const favs = state.favOrder
    .map(file => state.clips.find(c => c.file===file))
    .filter(Boolean);

  const nonFavs = state.clips
    .filter(c => !state.favSet.has(c.file))
    .sort((a,b) => a.label.localeCompare(b.label));

  // Build DOM
  favGrid.innerHTML = '';
  favs.forEach(c => favGrid.appendChild(cardEl(c, true)));
  allGrid.innerHTML = '';
  nonFavs.forEach(c => allGrid.appendChild(cardEl(c, false)));
}

function cardEl(c, isFav){
  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.id = c.id;
  card.dataset.file = c.file;

  const top = document.createElement('div');
  top.className = 'toprow';

  const label = document.createElement('div');
  label.className = 'label';
  label.textContent = c.label;

  const star = document.createElement('button');
  star.className = 'star' + (isFav ? ' fav' : '');
  star.textContent = isFav ? '★' : '☆';
  star.title = isFav ? 'Remove favorite' : 'Add to favorites';
  star.addEventListener('click', (e)=>{
    e.stopPropagation(); // don’t play
    toggleFavorite(c.file);
  });

  top.append(label, star);
  card.append(top);

  // Play on card click
  card.addEventListener('click', ()=> playClip(c, card));

  return card;
}

function toggleFavorite(file){
  const wasFav = state.favSet.has(file);
  if(wasFav){
    // remove
    state.favSet.delete(file);
    state.favOrder = state.favOrder.filter(f => f !== file);
  }else{
    // add: most-recently-starred goes to TOP
    state.favSet.add(file);
    state.favOrder = [file, ...state.favOrder.filter(f => f !== file)];
  }
  savePrefs();
  render();
}

function playClip(c, card){
  if(ALLOW_OVERLAP === false) stopAll();
  // stop if same is playing
  if(state.playing && state.playing.id === c.id){
    stopAll();
    return;
  }
  const a = new Audio(c.file);
  a.onended = stopAll;
  a.onplay  = ()=> card.classList.add('playing');
  a.onpause = ()=> card.classList.remove('playing');
  state.playing = { audio:a, id:c.id, card };
  a.play().catch(()=>{});
}

function stopAll(){
  if(state.playing){
    try{ state.playing.audio.pause(); }catch{}
    try{ state.playing.audio.currentTime = 0; }catch{}
    state.playing.card?.classList.remove('playing');
    state.playing = null;
  }
}

// Keyboard: 1–9 quick play from favorites first, then others
document.addEventListener('keydown', (e)=>{
  if(e.target.matches('input,textarea')) return;
  const n = parseInt(e.key,10);
  if(n>=1 && n<=9){
    const favCards = [...favGrid.querySelectorAll('.card')];
    const allCards = [...allGrid.querySelectorAll('.card')];
    const list = [...favCards, ...allCards];
    const target = list[n-1];
    if(target){
      const id = Number(target.dataset.id);
      const c = state.clips.find(x => x.id === id);
      if(c) playClip(c, target);
    }
  }
});

init().catch(err=>{
  allGrid.innerHTML = '<div style="opacity:.8">Could not load sounds.json.</div>';
  console.error(err);
});
</script>
</body>
</html>
